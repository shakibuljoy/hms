{% extends "base.html" %}

{% block content %}

<div class="container mt-4">
    <form method="post" id="item-form">
    <table style="text-align: center;" class="table table-striped">
        <thead>
            <tr>
                <th>Item</th>
                <th>Price</th>
                <th style="width:150px;">Unit</th>
                <th>Amount</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody class="formset-container">
                {% csrf_token %}
                {{ formset.management_form }}
                {%for form in formset%}
                <tr class="formset-row">
                    <td>{{form.item}}</td>
                    <td class="price">0.0</td>
                    <td onchange="unitChange(this)" onkeyup="unitChange(this)" class="unit">{{form.unit}}</td> 
                    <td class="amount">0.0</td> 
                    <td class="add-button"> 
                        <span class="add-item btn btn-primary">+</span> 
                        <span class="del-item btn btn-danger">-</span>
                     </td> 
                </tr>
                {%endfor%}
                <button class="btn btn-warning mb-2" >Submit</button>
        </tbody>
    </table>
</form>
</div>

{% endblock content %}
{%block jsscript%}


<script>
 document.addEventListener('DOMContentLoaded', function () {
    const formsetContainer = document.querySelector('.formset-container'); // Add a container class to your formset
    const selectedOptions = document.getElementById('id__itemcount_-0-item').innerHTML;

    formsetContainer.addEventListener('click', function (event) {
        const target = event.target;

        if (target.classList.contains('add-item')) {
            addItem();
        } else if (target.classList.contains('del-item')) {
            delItem(target);
        }
    });

    function addItem() {
        const formIndex = formsetContainer.querySelectorAll('.formset-row').length;
        const newForm = document.createElement('tr');
        newForm.className = 'formset-row';
        newForm.innerHTML = `<td><select class="form-control" id="id__itemcount_-${formIndex}-item" name="_itemcount_-${formIndex}-item" onchange="itemChange(this)">${selectedOptions}</select></td>
            <td class="price">0.0</td>
            <td class="unit" onchange="unitChange(this)" onkeyup="unitChange(this)"><input class="form-control" id="id__itemcount_-${formIndex}-unit" name="_itemcount_-${formIndex}-unit" step="1" type="number" value="1"></td>
            <td class="amount">0.0</td>
            <td class="add-button">
                <span class="add-item btn btn-primary">+</span>
                <span class="del-item btn btn-danger">-</span>
            </td>`;

        formsetContainer.appendChild(newForm);
    }

    function delItem(target) {
        const targetForm = target.closest('.formset-row');
        targetForm.remove();
    }
});

    </script>


<script>
function itemChange(selectElement) {
  const itemId = selectElement.value; // Get the selected item's ID
  // Make a GET request to fetch the price for the selected item
  fetch(`/get_price/${itemId}`) // Assuming the URL endpoint for fetching price
    .then(response => response.json())
    .then(data => {
      const priceElement = selectElement.closest('tr').querySelector('.price');
      const amountElement = selectElement.closest('tr').querySelector('.amount');
      const unitElement = selectElement.closest('tr').querySelector('.unit').querySelector('input').value;
      priceElement.textContent = data.price; // Update the price in the cell
      amountElement.textContent = data.price * unitElement; 
    })
    .catch(error => console.error('Error fetching price:', error));
}
</script>
<script>
    function unitChange(selectedElemet){
        const getValue = selectedElemet.querySelector('input').value;
        const itemRate = selectedElemet.closest('tr').querySelector('.price').textContent;
        const itemAmount = selectedElemet.closest('tr').querySelector('.amount');
        itemAmount.textContent = itemRate * getValue; 
        console.log(selectedElemet.querySelector('input').value)
    }
</script>
{%endblock jsscript%}